## Codebase Patterns
- Use `sleep` utility from `src/utils/sleep.ts` for async delays
- ProxyServer reads env vars in constructor for configuration
- Pre-delay is applied in both HTTP (#setupHttpProxy) and WebSocket (#setupWebsocketProxy onMessage) handlers
- Logging via `this.logger?.info()` and `this.logger?.trace()`

---

# Progress Log

## 2026-01-13 - US-001
Thread: https://ampcode.com/threads/T-019bba0f-34e1-716c-8dcc-243ea8aa9eeb
- Implemented pre-request delay via PROXY_PRE_DELAY_MS environment variable
- Created `src/utils/sleep.ts` utility function
- Added `preDelayMs` property to ProxyServer read from env
- Applied pre-delay before forwarding in HTTP handler (before fetch)
- Applied pre-delay in WebSocket handler (before upstream.send)
- Added logging at startup when pre-delay is set
- Files changed: src/ProxyServer.ts, src/utils/sleep.ts
- **Learnings for future iterations:**
  - Use node v18+ for TypeScript compilation (tsc path: node_modules/typescript/bin/tsc)
  - WebSocket onMessage handler made async to support await for delay
---


## 2026-01-13 - US-002
Thread: https://ampcode.com/threads/T-019bba13-c92b-742d-b948-cea11f21922b
- Implemented post-response delay via PROXY_POST_DELAY_MS environment variable
- Added `postDelayMs` property to ProxyServer read from env
- Applied post-delay in HTTP handler (after fetch response, before returning to client)
- Applied post-delay in WebSocket handler (made upstream message listener async, added await before sending to client)
- Added logging at startup when post-delay is set
- Files changed: src/ProxyServer.ts
- **Learnings for future iterations:**
  - WebSocket upstream message handler needed to be made async to support await for delay
  - Pattern mirrors pre-delay but applied after receiving upstream response
---

## 2026-01-13 - US-003
Thread: https://ampcode.com/threads/T-019bba15-57b0-745e-8874-150377be8941
- Added setPreDelay(ms: number) and setPostDelay(ms: number) methods to ProxyServer
- Methods directly set preDelayMs and postDelayMs properties, overriding env var values
- Added trace logging when methods are called
- Files changed: src/ProxyServer.ts
- **Learnings for future iterations:**
  - Existing delay properties (preDelayMs, postDelayMs) are already private, so methods just set them directly
  - bun is available for running tsc when pnpm/npx/node aren't in PATH
---
